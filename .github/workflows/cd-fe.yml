name: cd

on:
  push:
    branches:
      - 'main'
    paths:
      - '.github/workflows/cd-fe.yml'
      - 'fe/**'
  workflow_dispatch:

jobs:
  build:
    environment: CD
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Create .env file for build
        run: |
          cd fe
          cat > .env << 'EOF'
          ${{ secrets.FE_ENV_FILE }}
          EOF

      - name: Build docker image
        run: |
          docker build -t ${{ vars.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_HUB_REPOSITORY }}:${{ vars.DOCKER_HUB_TAGNAME }} ./fe

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Publish to docker hub
        run: |
          docker push ${{ vars.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_HUB_REPOSITORY }}:${{ vars.DOCKER_HUB_TAGNAME }}

      - name: Deploy on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ vars.SSH_HOST }}
          port: ${{ vars.SSH_PORT }}
          username: ${{ vars.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "Login docker hub for private repository access"
            echo ${{ secrets.DOCKER_HUB_TOKEN }} | docker login -u ${{ vars.DOCKER_HUB_USERNAME }} --password-stdin

            echo "Pull docker image"
            docker pull ${{ vars.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_HUB_REPOSITORY }}:${{ vars.DOCKER_HUB_TAGNAME }}

            echo "Move to project directory"
            cd ${{ vars.PROJECT_DIRECTORY }}

            echo "Stop existing containers"
            docker compose down

            echo "Create docker-compose.yml file"
            cat > docker-compose.yml << 'EOF'
            services:
              app:
                image: ${{ vars.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_HUB_REPOSITORY }}:${{ vars.DOCKER_HUB_TAGNAME }}
                ports:
                  - '3000:3000'
                env_file:
                  - .env
                restart: unless-stopped
            EOF

            echo "Start updated service"
            docker compose up -d

# secrets
# - DOCKER_HUB_TOKEN
# - SSH_PRIVATE_KEY
# - ENV_FILE

# vars
# - SSH_HOST
# - SSH_PORT
# - SSH_USERNAME
# - DOCKER_HUB_USERNAME
# - DOCKER_HUB_REPOSITORY
# - DOCKER_HUB_TAGNAME
# - PROJECT_DIRECTORY
