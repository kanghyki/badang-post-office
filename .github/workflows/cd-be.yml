name: cd-be

on:
  push:
    branches:
      - "main"
    paths:
      - ".github/workflows/cd-be.yml"
      - "be/**"
  workflow_dispatch:

jobs:
  build:
    environment: cd
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v4

      - name: Build docker image
        run: |
          docker build -t ${{ vars.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_HUB_REPOSITORY }}:${{ vars.DOCKER_HUB_BE_TAGNAME }} ./be

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Publish to docker hub
        run: |
          docker push ${{ vars.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_HUB_REPOSITORY }}:${{ vars.DOCKER_HUB_BE_TAGNAME }}

      - name: Deploy on Server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ vars.SSH_HOST }}
          port: ${{ vars.SSH_PORT }}
          username: ${{ vars.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "Login docker hub for private repository access"
            echo ${{ secrets.DOCKER_HUB_TOKEN }} | docker login -u ${{ vars.DOCKER_HUB_USERNAME }} --password-stdin

            echo "Pull docker image"
            docker pull ${{ vars.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_HUB_REPOSITORY }}:${{ vars.DOCKER_HUB_BE_TAGNAME }}

            echo "Move to project directory"
            cd ${{ vars.BE_PROJECT_DIRECTORY }}

            echo "Ensure static directory exists on server"
            mkdir -p static/templates static/fonts static/uploads static/generated data

            echo "Stop existing containers"
            docker compose down

            echo "Copy .env file"
            cat > .env << 'EOF'
            ${{ secrets.BE_ENV_FILE }}
            EOF

            echo "Create docker-compose.yml file"
            cat > docker-compose.yml << 'EOF'
            services:
              redis:
                image: redis:7-alpine
                container_name: jeju-redis
                command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
                volumes:
                  - redis-data:/data
                healthcheck:
                  test: ["CMD", "redis-cli", "ping"]
                  interval: 10s
                  timeout: 5s
                  retries: 5
                  start_period: 10s
                restart: unless-stopped
                networks:
                  - jeju-network
                logging:
                  driver: "json-file"
                  options:
                    max-size: "10m"
                    max-file: "3"

              badang-be:
                container_name: badang-be
                image: ${{ vars.DOCKER_HUB_USERNAME }}/${{ vars.DOCKER_HUB_REPOSITORY }}:${{ vars.DOCKER_HUB_BE_TAGNAME }}
                restart: unless-stopped
                env_file:
                  - .env
                environment:
                  - REDIS_HOST=redis
                  - REDIS_PORT=6379
                  - REDIS_DB=0
                networks:
                  - proxy-network
                  - jeju-network
                volumes:
                  - ./static:/app/static
                  - ./data:/app/data
                depends_on:
                  redis:
                    condition: service_healthy
                healthcheck:
                  test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s

            volumes:
              redis-data:
                driver: local

            networks:
              proxy-network:
                name: proxy-network
                external: true
              jeju-network:
                driver: bridge

            EOF

            echo "Start updated service"
            docker compose up -d
